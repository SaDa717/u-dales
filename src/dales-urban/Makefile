# ------------------------ Set variables ------------------------------
# Executable name
TARGET=dalesmerged
PLATFORM=cx1
DEBUG=FALSE

ifeq ($(PLATFORM),cx1)
 INCDIRS = $(MPI_HOME)/include
  LIBDIRS = $(MPI_HOME)/lib
  LIBS    = mpi

# Objects required for build
FSRC=$(wildcard *.f90)
FOBJS=$(FSRC:.f90=.o)
F77SRC=$(wildcard *.f)
F77OBJS=$(F77SRC:.f=.o)

  NETCDF      = /apps/netcdf/4.3.0
  LIBS       += netcdff90 netcdff netcdf
  INCDIRS    += $(NETCDF)/include $(MPI_HOME)/include
  LIBDIRS    += $(NETCDF)/lib

  FC          =  mpiifort
  FCOPTS     += -r8 -fpp -WB -fpe0 -extend_source -mcmodel=medium -i-dynamic
  FLOPTS      = -mcmodel=medium -i-dynamic
  FCOPTS77     += -r8 -fpp -WB -fpe0 -extend_source -mcmodel=medium -i-dynamic
  FLOPTS77      = -mcmodel=medium -i-dynamic
 ifeq ($(DEBUG),TRUE)
#    FCOPTS     += -g  -traceback -CB -check all
    FCOPTS     += -g -traceback
    FLOPTS     += -g -CB
    FCOPTS77   += -g  -traceback
    FLOPTS77   += -g
  else
    FCOPTS     += -O3 -ip -ftz
    FCOPTS77     += -O3 -ip -ftz
 endif

# ----------------------------------------------------------------------

# Some compiler and linker options
FCINCOPTS     =  $(patsubst %, -I%, $(INCDIRS))

FL            = $(FC)
FLOPTS       += 
FLLIBOPTS     = $(patsubst %, -L%, $(LIBDIRS)) $(patsubst %, -l%, $(LIBS))

VPATH = $(subst ,:,$(INCDIRS))
# ---------------------   Build rules -----------------------------------
.PHONY:  all
all: depend $(TARGET)

$(TARGET): $(F77OBJS) $(FOBJS) $(COBJS)
	$(FL) $(FLOPTS) -o $@ $(^F) $(FLLIBOPTS)

install: $(TARGET)
	cp $(TARGET) $(BINDIR)

.PHONY: clean
depend: $(FRSC) $(F77SRC)
	makedepf90 $(FSRC) $(F77SRC) > depend

%.mod %.o : %.f90
	$(FC) $(FCOPTS) $(FCINCOPTS) -c $<

%.mod %.o : %.f
	$(FC) $(FCOPTS77) $(FCINCOPTS) -c $<

# Include the dependencies file generated by makedepf90
include depend

clean:
	rm -f $(notdir $(F77OBJS) $(FOBJS) $(COBJS)) $(TARGET) *.mod

endif

ifeq ($(PLATFORM),cx2)
  INCDIRS = $(MPI_HOME)/include
  LIBDIRS = $(MPI_HOME)/lib
  LIBS    = mpi

# Objects required for build
FSRC=$(wildcard *.f90)
FOBJS=$(FSRC:.f90=.o)
F77SRC=$(wildcard *.f)
F77OBJS=$(F77SRC:.f=.o)

  NETCDFF      = /apps/netcdf/4.4.3-fortran
  NETCDF       = /apps/netcdf/4.4.0-c
  LIBS       += netcdf netcdff #netcdff90
  INCDIRS    += $(NETCDF)/include $(MPI_HOME)/include $(NETCDFF)/include
  LIBDIRS    += $(NETCDF)/lib $(NETCDFF)/lib

  FC          =  ifort
  FCOPTS     += -r8 -fpp -WB -fpe0 -extend_source -mcmodel=medium
  FLOPTS      = -mcmodel=medium
  FCOPTS77     += -r8 -fpp -WB -fpe0 -extend_source -mcmodel=medium
  FLOPTS77      = -mcmodel=medium
 ifeq ($(DEBUG),TRUE)
#    FCOPTS     += -g  -traceback -CB -check all
    FCOPTS     += -g -traceback
    FLOPTS     += -g -CB
    FCOPTS77   += -g  -traceback
    FLOPTS77   += -g
  else
    FCOPTS     += -O3 -ip -ftz
    FCOPTS77     += -O3 -ip -ftz
 endif

# ----------------------------------------------------------------------

# Some compiler and linker options
FCINCOPTS     =  $(patsubst %, -I%, $(INCDIRS))

FL            = $(FC)
FLOPTS       +=
FLLIBOPTS     = $(patsubst %, -L%, $(LIBDIRS)) $(patsubst %, -l%, $(LIBS))

VPATH = $(subst ,:,$(INCDIRS)) 

# ---------------------   Build rules -----------------------------------
.PHONY:  all
all: depend $(TARGET)

$(TARGET): $(F77OBJS) $(FOBJS) $(COBJS)
	$(FL) $(FLOPTS) -o $@ $(^F) $(FLLIBOPTS)

install: $(TARGET)
	cp $(TARGET) $(BINDIR)

.PHONY: clean
depend: $(FRSC) $(F77SRC)
	makedepf90 $(FSRC) $(F77SRC) > depend

%.mod %.o : %.f90
	$(FC) $(FCOPTS) $(FCINCOPTS) -c $<

%.mod %.o : %.f
	$(FC) $(FCOPTS77) $(FCINCOPTS) -c $<

# Include the dependencies file generated by makedepf90
include depend

clean:
	rm -f $(notdir $(F77OBJS) $(FOBJS) $(COBJS)) $(TARGET) *.mod

endif
